#!/usr/bin/env ruby
require 'benchmark'
require 'rubygems'
TEST_OPTIONS = {}
TEST_OPTIONS[:amount]= 10000
SUBJECT = {:name => ARGV[0].to_s.downcase}

unless ARGV[1].nil?
  test_count = ARGV[1].to_i

  raise('test count must be more than at least 10000') if test_count < 10000

  TEST_OPTIONS[:amount]= test_count
end


def run(app)
  SUBJECT[:instance] = app
end

benchmark_folder = File.realpath(File.dirname(File.dirname(__FILE__)))
app_folder = File.realpath(File.join(File.dirname(__FILE__), '..', 'apps', SUBJECT[:name].downcase))
config_file_path = File.join(app_folder, 'config.ru')

Dir.chdir(app_folder)
require 'bundler'
Bundler.require

load(config_file_path)

rack_env = {
    "REMOTE_ADDR" => "192.168.56.1",
    "REQUEST_METHOD" => 'GET',
    "REQUEST_PATH" => '/',
    "REQUEST_URI" => '/',
    "PATH_INFO" => '/',
    "SERVER_PROTOCOL" => "HTTP/1.1",
    "CONTENT_LENGTH" => "0",
    "CONTENT_TYPE" => "application/x-www-form-urlencoded",
    "SERVER_NAME" => "hds-dev.ett.local",
    "SERVER_PORT" => "80",
    "QUERY_STRING" => 'hello=world',
    "HTTP_VERSION" => "HTTP/1.1",
    "HTTP_USER_AGENT" => "spec",
    "HTTP_HOST" => "spec.local",
    "HTTP_ACCEPT_ENCODING" => "gzip;q=1.0,deflate;q=0.6,identity;q=0.3",
    "HTTP_ACCEPT" => "*/*",
    "HTTP_CONNECTION" => "close",
    "rack.input" => ::Rack::Lint::InputWrapper.new(StringIO.new(''))
}

require 'yaml'
benchmark_result = TEST_OPTIONS[:amount].times.map do
  env = rack_env.dup
  Benchmark.measure { SUBJECT[:instance].call(env) }
end


def load_file(file_path)
  file_content = File.read(file_path)
  return Hash.new if file_content.to_s.empty?
  YAML.load(file_content)
rescue Errno::ENOENT
  unless File.exist?(file_path)
    File.write(file_path, YAML.dump({}))
  end
  sleep(1)
  retry
end

measure_file_path = File.join(benchmark_folder, 'measure.yml')
benchmarks = load_file(measure_file_path)

gem_version = Gem.loaded_specs[SUBJECT[:name]].version.to_s
gem_space = (benchmarks[SUBJECT[:name]] ||= {})
results = (gem_space[gem_version] ||= [])

def avg(array,method)
  array.reduce(0.0){|r,bm| r + bm.public_send(method) } / array.length
end

user_time = avg(benchmark_result,:utime)
system_time = avg(benchmark_result,:stime)
total_time = avg(benchmark_result,:total)
real_time = avg(benchmark_result,:real)

results.push(
    {
        'user' => user_time,
        'system' => system_time,
        'total' => total_time,
        'real' => real_time,
        'weight' => TEST_OPTIONS[:amount]
    }
)

File.write(measure_file_path, YAML.dump(benchmarks))

exit